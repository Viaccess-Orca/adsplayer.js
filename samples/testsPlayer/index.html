<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- sources under test-->

        <!-- sources modify by gulp.replaceSourcesByBuild -->
        <!-- !!! DO NOT REMOVE OR CHANGE THE COMMENTS LINE ABOVE !!! -->
        <script src="../../dist/csadsplugin.js"></script>
        <!-- !!! DO NOT REMOVE OR CHANGE THE COMMENT LINE BELOW!!! -->
        <!-- endsources -->

        <!-- uses cswebplayer-->
        <script src="../hasplayer.min.js"></script>

        <style>
            .events_list, .event {
                display: flex;
            }

            .events_list {
                flex-wrap: wrap;
                width: 700px;
                margin-bottom: 10px;
            }

            .event {
                margin-bottom: 5px;
                width: 33%;
            }

            .event .event_title {
                min-width: 155px;
            }

            .event input {
                width: 30px;
            }
        </style>
    </head>

    <body>
        <div id="container" style="min-height: 300px">
            <video id="videoplayer-container" width="700" height="300" controls>  </video>
            <div id="adsplayer-container" width="700" height="300" controls> </div>
        </div>
        <div>
            <br>
            <input id="stream_toplay" type="text" size="100" value="http://playready.directtaps.net/smoothstreaming/SSWSS720H264/SuperSpeedway_720.ism/Manifest"> </input><br>
            <input id="ad_toplay" type="text" size="100" value="../ads/xml/mast/preroll.xml"> </input><br>
            <br>
            <button id="play_button" >Play</button>
            <button id="pause_button" >Pause</button>
            <button id="stop_button" >Stop</button><br>
            <h4>CSAdsPlugin Events</h4>
            <div class="events_list">
                <div class="event">
                    <div class="event_title">start</div>
                    <input id="event_start" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">stop</div>
                    <input id="event_end" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">add</div>
                    <input id="event_add" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">remove</div>
                    <input id="event_remove" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">play</div>
                    <input id="event_play" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">pause</div>
                    <input id="event_pause" type="number" value="0" disabled> </input>
                </div>
            </div>
            <button id="clearEvents_button" >Clear all</button><br>

            <h4>Tracking Events</h4>
            <div id="tracking_events" class="events_list">
                <div class="event">
                    <div class="event_title">creativeView</div>
                    <input id="te_creativeView" eventId="creativeView" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">start</div>
                    <input id="te_start" eventId="start" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">firstQuartile</div>
                    <input id="te_firstQuartile" eventId="firstQuartile" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">midpoint</div>
                    <input id="te_midpoint" eventId="midpoint" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">thirdQuartile</div>
                    <input id="te_thirdQuartile" eventId="thirdQuartile" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">complete</div>
                    <input id="te_complete" eventId="complete" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">mute</div>
                    <input id="te_mute" eventId="mute" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">unmute</div>
                    <input id="te_unmute" eventId="unmute" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">pause</div>
                    <input id="te_pause" eventId="pause" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">rewind</div>
                    <input id="te_rewind" eventId="rewind" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">resume</div>
                    <input id="te_resume" eventId="resume" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">fullscreen</div>
                    <input id="te_fullscreen" eventId="fullscreen" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">exitFullscreen</div>
                    <input id="te_exitFullscreen" eventId="exitFullscreen" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">expand</div>
                    <input id="te_expand" eventId="expand" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">collapse</div>
                    <input id="te_collapse" eventId="collapse" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">acceptInvitationLinear</div>
                    <input id="te_acceptInvitationLinear" eventId="acceptInvitationLinear" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">closeLinear</div>
                    <input id="te_closeLinear" eventId="closeLinear" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">skip</div>
                    <input id="te_skip" eventId="skip" type="number" value="0" disabled> </input>
                </div>
                <div class="event">
                    <div class="event_title">progress</div>
                    <input id="te_progress" eventId="progress" type="number" value="0" disabled> </input>
                </div>
            </div>
            <button id="clear_te_button" >Clear all</button>

        </div>

        <script>

            var mediaPlayer = null;
            var adPlayer = null;
            var adsPlugin = null;

            var onMainVideoPause = function(e) {
                if (document.querySelector('#pause_button').innerHTML == "Pause") {
                    mediaPlayer.pause();
                    document.querySelector('#pause_button').innerHTML = "Resume";
                } else {
                    mediaPlayer.play();
                    document.querySelector('#pause_button').innerHTML = "Pause";
                }
            }

            var onAdPause = function(e) {
                if (document.querySelector('#pause_button').innerHTML == "Pause") {
                    adPlayer.pause();
                    document.querySelector('#pause_button').innerHTML = "Resume";
                } else {
                    adPlayer.play();
                    document.querySelector('#pause_button').innerHTML = "Pause";
                }
            }

            document.addEventListener("DOMContentLoaded", function(event){

                adsPlugin = new adsplayer.AdsPlayer(document.getElementById('adsplayer-container'));

                // hide the video player and update the number of start event
                adsPlugin.addEventListener('start', function(e) {
                    document.getElementById('videoplayer-container').style.display = 'none' ;
                    var element = document.getElementById('event_start');
                    element.setAttribute("value", parseInt(element.getAttribute("value")) + 1);
                });

                // show the video player and update the number of end event
                adsPlugin.addEventListener('end', function(e) {
                    document.getElementById('videoplayer-container').style.display = 'block';
                    var element = document.getElementById('event_end');
                    element.setAttribute("value", parseInt(element.getAttribute("value")) + 1);
                });

                adsPlugin.addEventListener('addElement', function(e) {
                    var element = document.getElementById('event_add');
                    element.setAttribute("value", parseInt(element.getAttribute("value")) + 1);
                    // Store the adPlayer element
                    adPlayer = e.data.element;
                    // Change the listener for the pause button
                    document.querySelector('#pause_button').removeEventListener("click", onMainVideoPause);
                    document.querySelector('#pause_button').addEventListener("click", onAdPause);
                });

                adsPlugin.addEventListener('removeElement', function(e) {
                    var element = document.getElementById('event_remove');
                    element.setAttribute("value", parseInt(element.getAttribute("value")) + 1);
                    // Change the listener for the pause button
                    document.querySelector('#pause_button').removeEventListener("click", onAdPause);
                    document.querySelector('#pause_button').addEventListener("click", onMainVideoPause);
                });

                adsPlugin.addEventListener('play', function(e) {
                    var element = document.getElementById('event_play');
                    element.setAttribute("value", parseInt(element.getAttribute("value")) + 1);
                });

                adsPlugin.addEventListener('pause', function(e) {
                    var element = document.getElementById('event_pause');
                    element.setAttribute("value", parseInt(element.getAttribute("value")) + 1);
                });

                mediaPlayer = new MediaPlayer();

                mediaPlayer.init(document.getElementById('videoplayer-container'));

                mediaPlayer.setDebug(false);

                mediaPlayer.addPlugin(adsPlugin);

                // play button
                document.querySelector('#play_button').addEventListener("click",function(e) {
                    var stream = {
                        url : document.getElementById("stream_toplay").value,
                        protData : null,
                        adsUrl : document.getElementById("ad_toplay").value
                    };

                    mediaPlayer.load(stream);
                });

                // stop button
                document.querySelector('#stop_button').addEventListener("click",function(e) {
                    mediaPlayer.stop();
                });

                // pause button
                document.querySelector('#pause_button').addEventListener("click", onMainVideoPause);

                // clear events button
            	document.querySelector('#clearEvents_button').addEventListener("click",function(e) {
	                document.getElementById('event_start').setAttribute("value", 0);
	                document.getElementById('event_end').setAttribute("value", 0);
	                document.getElementById('event_add').setAttribute("value", 0);
	                document.getElementById('event_remove').setAttribute("value", 0);
	                document.getElementById('event_play').setAttribute("value", 0);
	                document.getElementById('event_pause').setAttribute("value", 0);
            	});
            });

            /** TRACKING EVENTS **/

            var s_ajaxListener = new Object();

            // Added for IE support
            if (typeof XMLHttpRequest === "undefined") {
                XMLHttpRequest = function () {
                    try { return new ActiveXObject("Msxml2.XMLHTTP.6.0"); }
                    catch (e) {}
                    try { return new ActiveXObject("Msxml2.XMLHTTP.3.0"); }
                    catch (e) {}
                    try { return new ActiveXObject("Microsoft.XMLHTTP"); }
                    catch (e) {}
                    throw new Error("This browser does not support XMLHttpRequest.");
                };
            }

            s_ajaxListener.tempOpen = XMLHttpRequest.prototype.open;
            s_ajaxListener.tempSend = XMLHttpRequest.prototype.send;

            // Callback for XHR
            s_ajaxListener.callback = function () {
                // this.method: the ajax method used
                // this.url   : the url of the requested script (including query string, if any) (urlencoded)
                // this.data  : the data sent, if any ex: foo=bar&a=b (urlencoded)
                if (this.url.indexOf("http://cswebplayer.viaccess.fr/adsserver/js?event=")!=-1) {
                    // Get event name from URL
                    var newEvent = this.data.split("=");
                    if (newEvent &&
                        newEvent.length > 1) {
                        // Get input element from DOM
                        var element = document.querySelector('#te_' + newEvent[1]);
                        if (element) {
                            // Increment event counter
                            element.setAttribute("value", parseInt(element.getAttribute("value")) + 1);
                        }
                    }
                }
            }

            XMLHttpRequest.prototype.open = function(a,b) {
                if (!a) var a='';
                if (!b) var b='';
                s_ajaxListener.tempOpen.apply(this, arguments);
                s_ajaxListener.method = a;
                s_ajaxListener.url = b;
                if (a.toLowerCase() == 'get') {
                    s_ajaxListener.data = b.split('?');
                    s_ajaxListener.data = s_ajaxListener.data[1];
                }
            }

            XMLHttpRequest.prototype.send = function(a,b) {
                if (!a) var a='';
                if (!b) var b='';
                s_ajaxListener.tempSend.apply(this, arguments);
                if(s_ajaxListener.method.toLowerCase() == 'post')s_ajaxListener.data = a;
                s_ajaxListener.callback();
            }

            // "Clear all" button
            document.querySelector('#clear_te_button').addEventListener("click",function(e) {
                // Get tracking event input elements
                var inputs = document.querySelectorAll("#tracking_events .event input");
                for (var i = 0; i < inputs.length; i++) {
                    // Reset input value
                    inputs[i].setAttribute("value", 0);
                }
            });
        </script>
    </body>
</html>
